# 高精度RAGシステム - 統合版

## 📋 概要

このプロジェクトは、最新のAI技術を統合した高精度なRAG（Retrieval Augmented Generation）システムです。  
様々なRAGシステムのベースプロジェクトとして利用可能な汎用設計となっています。

## 🚀 主要機能

### ✨ 高精度検索システム
- **ハイブリッド検索**: BM25（キーワード検索） + セマンティック検索の組み合わせ
- **リランキング**: BGE Rerankerによる検索結果の精度向上
- **動的チャンク分割**: コンテンツに応じた最適な文書分割

### 📊 評価・監視システム
- **Ragas評価フレームワーク**: 業界標準の定量的評価
- **リアルタイムダッシュボード**: 性能監視とメトリクス可視化
- **LangSmithトレーシング**: 詳細な実行追跡（オプション）

### 🔒 セキュリティ機能
- **OWASP LLM Top 10対応**: プロンプトインジェクション対策
- **入出力検証**: 包括的なセキュリティチェック
- **レート制限**: DDoS攻撃防止

### 🎯 3つの動作モード
- **SEO質問モード**: SEOに関する質問応答と情報源明示
- **ドメイン分析モード**: 指定URLのSEO分析とスコアリング
- **社内文書検索**: 関連文書の特定と表示

### 📝 文字数評価システム（Phase 1-3実装済み）

本システムには、ページの文字数を評価する高度な機能が実装されています。

#### システムの特徴

**選択肢形式による推奨提示**  
従来の「文字数が少ない」といった断定的な判断を避け、ページの種類に応じた選択肢を提示します。

#### 評価基準（SEO検定資料SEO3-3準拠）

**トップページ/メインページの推奨文字数:**
- **物販サイトなどのトップページ**: 0～800字程度
- **来店型ビジネス** (クリニック、美容室、整体院等): 700～2,500字程度
- **単品サービスや単品通販のトップページ**: 4,000字以上

**サブページの推奨文字数:**
- **単純な概念の解説**: 1,500字程度
- **複雑な事柄の説明**: 4,000字以上

**YMYL分野の特別対応:**
- 医療、健康、金融、法律などのYMYL分野では上記**それぞれの文字数の2倍**が推奨されます

#### 3層アーキテクチャ

1. **Phase 1: 評価ロジック層** (domain_analyzer.py)
   - ページの文字数を計測し、選択肢形式のメッセージを生成
   - スコアリングは控えめ（400字未満: -2点、2000字以上: +2点のみ）
   - 断定的な表現を排除

2. **Phase 2: プロンプト制御層** (utils.py, constants.py)
   - LLMへのシステムプロンプトに【文字数に関する回答ルール】を追加
   - 選択肢形式での回答を強制
   - 断定的な判断の回避を明示

3. **Phase 3: RAG最適化層** (utils.py)
   - 文字数関連の質問を自動検出
   - SEO3-3資料のキーワードを強制注入（ページ構造、上位表示、700文字、2500文字等）
   - SEO3-3資料に30%のボーナススコアを適用し優先的に取得

#### 文字数抽出の精度向上

- `<article>`タグを優先的に使用（100字以上の場合）
- 100字未満の場合は`<main>`タグにフォールバック
- ナビゲーション等のノイズを除外

## 📦 セットアップ

### 前提条件
- Python 3.11以上
- Windows 10/11 （macOS・Linuxでも動作可能）

### 1. 環境構築

```bash
# 仮想環境作成（推奨）
python -m venv env
env\Scripts\activate  # Windows
# source env/bin/activate  # macOS/Linux

# パッケージインストール
pip install -r requirements.txt
```

### 2. 環境変数設定

`.env` ファイルを編集して必要な設定を行います：

```env
# 必須設定
OPENAI_API_KEY=your_openai_api_key_here

# オプション設定（高度な監視用）
LANGSMITH_TRACING=true
LANGSMITH_API_KEY=your_langsmith_api_key_here

# セキュリティ設定
SECURITY_ENABLED=true
MAX_REQUESTS_PER_MINUTE=20
```

#### OpenAI API Key取得方法
1. [OpenAI Platform](https://platform.openai.com/)でアカウント作成
2. API Keys セクションで新しいキーを作成
3. `.env`ファイルの`OPENAI_API_KEY`に設定

#### LangSmith API Key取得方法（オプション）
1. [LangSmith](https://smith.langchain.com/)でアカウント作成
2. Settings → API Keys で新しいキーを作成
3. `.env`ファイルの`LANGSMITH_API_KEY`に設定

### 3. データ準備

`data/` フォルダに参照したい文書を配置：

```
data/
├── MTG議事録/
├── 社員について/
├── 会社について/
└── ...
```

サポート形式: PDF, DOCX, CSV, TXT

### 4. 起動

```bash
streamlit run main.py
```

ブラウザで `http://localhost:8501` にアクセス

## 🎯 使用方法

### 基本操作

1. **モード選択**: 「社内文書検索」または「社内問い合わせ」を選択
2. **質問入力**: 画面下部のチャット欄に質問を入力
3. **結果確認**: AIが関連文書を検索して回答を生成

### 高精度モード確認

- **🚀 アイコン**: 高精度機能有効（ハイブリッド検索・評価・セキュリティ）
- **⚙️ アイコン**: 標準モード

### 評価ダッシュボード

「📊 評価ダッシュボード」ボタンから以下が確認可能：

- システム性能メトリクス
- 検索精度の時系列変化
- カスタムテストケース管理
- セキュリティ監視

## 🧪 テストスイート

本プロジェクトには包括的なテストスイートが用意されています。

### Phase 3テスト: RAGクエリ最適化

```bash
python test_phase3_query_expansion.py
```

- クエリ拡張の効果検証
- SEO3-3キーワード注入の確認
- 6つのシナリオでカバレッジ測定

### Phase 4テスト: 総合システムテスト

```bash
python test_content_volume_comprehensive.py
```

実施内容:
- ✅ 文字数評価メッセージの形式確認（7パターン）
- ✅ YMYLドメイン検出（8ケース）
- ✅ ページタイプ分類（5タイプ）
- ✅ スコアリングの妥当性（8段階）
- ✅ エンドツーエンド統合フロー確認
- ✅ Phase 1-3実装の存在確認

## 🔧 カスタマイズ

### 主要設定ファイル

| ファイル | 役割 | カスタマイズポイント |
|---------|------|----------------------|
| `constants.py` | 設定値・プロンプト | モデル、チャンクサイズ、プロンプト |
| `utils.py` | RAG・クエリ処理 | クエリ拡張、文書選択アルゴリズム |
| `domain_analyzer.py` | ドメイン分析 | スコアリングロジック、評価基準 |
| `security_system.py` | セキュリティ | セキュリティルール、制限値 |

### 文字数評価システムのカスタマイズ

**推奨文字数の変更** (domain_analyzer.py 1938-1964行目):
```python
# トップページやサブページの推奨文字数を変更可能
suggestions.append(
    f"現在の文字数は{page_chars}字です。ページの種類により推奨文字数が異なります：\n"
    "【トップページ/メインページの場合】\n"
    "  ・物販サイトなど: 0～800字程度\n"  # ← ここを変更
    "  ・来店型ビジネス: 700～2,500字程度\n"
    "  ・単品サービスや単品通販: 4,000字以上\n"
    ...
)
```

**スコアリング閾値の調整** (domain_analyzer.py 1959-1965行目):
```python
if page_chars < 400:      # ← 下限閾値
    context_adjustments["content_volume"] = -2
elif page_chars >= 2000:  # ← 上限閾値
    context_adjustments["content_volume"] = +2
```

**RAGクエリ拡張の調整** (utils.py 1229-1290行目):
```python
'文字数': [
    '文字数', '推奨文字数', ...  # ← キーワードを追加/削除
]
```

## 📈 性能指標

### 期待される改善効果

- **検索精度**: 35-45% 向上（従来比）
- **回答品質**: 25-35% 向上
- **セキュリティ**: 包括的な保護機能
- **運用効率**: 自動監視による50%効率化

### 監視可能メトリクス

- 成功率（正常応答の割合）
- 関連性スコア（検索結果の質）
- 処理時間（応答速度）
- セキュリティイベント数

## 🛠️ トラブルシューティング

### よくある問題

1. **パッケージインストールエラー**
   ```bash
   # 個別インストールを試行
   pip install langchain
   pip install streamlit
   ```

2. **文字エンコーディングエラー**
   - Windows環境での日本語処理は自動調整済み
   - ログファイル確認: `logs/application.log`

3. **API Key関連**
   - `.env`ファイルの設定確認
   - APIキーの有効性確認

### ログ確認

```bash
# エラーログ確認
type logs\application.log | findstr "ERROR"  # Windows
# grep "ERROR" logs/application.log  # macOS/Linux
```

## 📚 技術スタック

- **フレームワーク**: Streamlit, LangChain
- **AI・ML**: OpenAI GPT-4, Sentence Transformers
- **検索**: ChromaDB, BM25, BGE Reranker
- **評価**: Ragas, LangSmith
- **セキュリティ**: Presidio, カスタム検証
- **UI**: Plotly, Pandas

## 🤝 開発・拡張

このシステムは以下の拡張が容易に行えるよう設計されています：

- 新しい文書形式のサポート
- カスタム検索アルゴリズム
- 独自の評価指標
- 外部システム連携
- マルチテナント対応

## � 実装履歴

### 文字数評価システム（2025年11月）

**Phase 1: 評価ロジックの改善**
- 断定的な判断から選択肢形式への変更
- ページタイプ別の推奨文字数の明示（物販サイト、来店型ビジネス、単品サービス/単品通販）
- メインページかサブページかの自動判断を廃止し、すべての選択肢を提示
- YMYL分野のそれぞれの文字数の2倍基準の追加
- スコアリングの控えめな調整

**Phase 2: システムプロンプトの強化**
- LLMへの回答ルールの明示
- 選択肢形式の強制
- utils.pyとconstants.pyの両方に実装

**Phase 3: RAG検索の最適化**
- クエリ拡張マップの大幅拡充（5→20+キーワード）
- 文字数関連質問の自動検出
- SEO3-3資料への30%ボーナススコア適用
- 強制キーワード注入による検索精度向上

**Phase 4: 総合テストスイート作成**
- 7パターンの文字数評価テスト
- 8ケースのYMYL検出テスト
- 5タイプのページ分類テスト
- エンドツーエンド統合テスト

**Phase 5: ドキュメント整備**
- README.mdへの詳細な説明追加
- カスタマイズ方法の文書化
- テスト手順の明示

### バグ修正

**文字数抽出の精度向上**
- 問題: `<article>`タグから47文字しか抽出できないケース
- 解決: 100字閾値とフォールバック機構の実装
- 結果: 47字 → 478字の正確な抽出

**ドメイン分析モードのSEOチェック回避**
- 問題: ページタイトルにSEOキーワードがない場合にエラー
- 解決: `skip_seo_check`パラメータの追加
- 結果: ドメイン分析が正常動作

## �📄 ライセンス

このプロジェクトは教育・研究目的で作成されています。  
商用利用の際は各パッケージのライセンスを確認してください。

---

**作成日**: 2025年10月26日  
**バージョン**: 1.0.0  
**対応Python**: 3.11+